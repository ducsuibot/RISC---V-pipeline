`timescale 1ns/1ps

module riscv_pipeline (
    // Inputs
    input wire clk,                          // System clock signal
    input wire rst,                          // System reset signal (active low)
    
    // Outputs (for debugging or external monitoring, if needed)
    output wire [31:0] Instr_D,              // Instruction fetched from memory
    output wire [31:0] PC_D,                 // Program Counter value at Decode stage
    output wire [31:0] PCPlus4_D,            // PC + 4 value at Decode stage
    output wire RegWrite_E,                  // Register Write enable signal at Execute stage
    output wire ALUSrc_E,                    // ALU Source select signal at Execute stage
    output wire MemWrite_E,                  // Memory Write enable signal at Execute stage
    output wire Branch_E,                    // Branch condition signal at Execute stage
    output wire Jump_E,                      // Jump condition signal at Execute stage
    output wire [1:0] ResultSrc_E,           // Result Source select signal at Execute stage
    output wire [2:0] ALUControl_E,          // ALU Control signal at Execute stage
    output wire [2:0] funct3_E,              // Function code (funct3) at Execute stage
    output wire [31:0] RD1_E,                // Register Data 1 at Execute stage
    output wire [31:0] RD2_E,                // Register Data 2 at Execute stage
    output wire [31:0] Imm_Ext_E,            // Immediate Extended value at Execute stage
    output wire [4:0] RD_E,                  // Destination Register at Execute stage
    output wire [4:0] RS1_E,                 // Source Register 1 at Execute stage
    output wire [4:0] RS2_E,                 // Source Register 2 at Execute stage
    output wire [4:0] RS1_D,                 // Source Register 1 at Decode stage
    output wire [4:0] RS2_D,                 // Source Register 2 at Decode stage
    output wire [31:0] PC_E,                 // Program Counter value at Execute stage
    output wire [31:0] PCPlus4_E,            // PC + 4 value at Execute stage
    output wire PCSrc_E,                     // PC Source select signal at Execute stage
    output wire RegWrite_M,                  // Register Write enable signal at Memory stage
    output wire MemWrite_M,                  // Memory Write enable signal at Memory stage
    output wire [1:0] ResultSrc_M,           // Result Source select signal at Memory stage
    output wire [4:0] RD_M,                  // Destination Register at Memory stage
    output wire [31:0] PCPlus4_M,            // PC + 4 value at Memory stage
    output wire [31:0] WriteData_M,          // Write Data at Memory stage
    output wire [31:0] ALU_Result_M,         // ALU Result at Memory stage
    output wire RegWrite_W,                  // Register Write enable signal at Writeback stage
    output wire [1:0] ResultSrc_W,           // Result Source select signal at Writeback stage
    output wire [4:0] RD_W,                  // Destination Register at Writeback stage
    output wire [31:0] PCPlus4_W,            // PC + 4 value at Writeback stage
    output wire [31:0] ALU_Result_W,         // ALU Result at Writeback stage
    output wire [31:0] ReadData_W,           // Read Data from memory at Writeback stage
    output wire [31:0] Result_W,             // Final Result written back to register file
    output wire [1:0] ForwardA_E,            // Forwarding control for Source A at Execute stage
    output wire [1:0] ForwardB_E,            // Forwarding control for Source B at Execute stage
    output wire Stall_F,                     // Stall signal for Fetch stage
    output wire Stall_D,                     // Stall signal for Decode stage
    output wire Flush_D,                     // Flush signal for Decode stage
    output wire Flush_E,                     // Flush signal for Execute stage
    output wire [31:0] PC_Target_E           // PC Target address at Execute stage
);

    wire [31:0] Instr_D, PC_D, PCPlus4_D;
    wire RegWrite_E, ALUSrc_E, MemWrite_E, Branch_E, Jump_E;
    wire [1:0] ResultSrc_E;
    wire [2:0] ALUControl_E, funct3_E;
    wire [31:0] RD1_E, RD2_E, Imm_Ext_E;
    wire [4:0] RD_E, RS1_E, RS2_E, RS1_D, RS2_D;
    wire [31:0] PC_E, PCPlus4_E;
    wire RegWrite_M, MemWrite_M;
    wire [1:0] ResultSrc_M;
    wire [4:0] RD_M;
    wire [31:0] PCPlus4_M, WriteData_M, ALU_Result_M;
    wire RegWrite_W;
    wire [1:0] ResultSrc_W;
    wire [4:0] RD_W;
    wire [31:0] PCPlus4_W, ALU_Result_W, ReadData_W;
    wire [31:0] Result_W;
    wire [1:0] ForwardA_E, ForwardB_E;
    wire Stall_F, Stall_D, Flush_D, Flush_E;
    wire [31:0] PC_Target_E;

    fetch_cycle fetch (
        .clk(clk), .rst(rst),
        .Stall_F(Stall_F), .Stall_D(Stall_D), .Flush_D(Flush_D),
        .PCSrc_E(PCSrc_E), .PC_Target_E(PC_Target_E),
        .Instr_D(Instr_D), .PC_D(PC_D), .PCPlus4_D(PCPlus4_D)
    );

    decode_cycle decode (
        .clk(clk), .rst(rst), .RegWriteW(RegWrite_W), .RDW(RD_W), .ResultW(Result_W),
        .Flush_E(Flush_E), .Instr_D(Instr_D), .PC_D(PC_D), .PCPlus4_D(PCPlus4_D),
        .RegWrite_E(RegWrite_E), .ALUSrc_E(ALUSrc_E), .MemWrite_E(MemWrite_E), .Branch_E(Branch_E), .Jump_E(Jump_E),
        .ResultSrc_E(ResultSrc_E), .ALUControl_E(ALUControl_E), .funct3_E(funct3_E),
        .RD1_E(RD1_E), .RD2_E(RD2_E), .Imm_Ext_E(Imm_Ext_E),
        .RD_E(RD_E), .RS1_E(RS1_E), .RS2_E(RS2_E), .RS1_D(RS1_D), .RS2_D(RS2_D),
        .PC_E(PC_E), .PCPlus4_E(PCPlus4_E)
    );

    execute_cycle execute (
        .clk(clk), .rst(rst), .RegWrite_E(RegWrite_E), .ALUSrc_E(ALUSrc_E), .MemWrite_E(MemWrite_E), .Branch_E(Branch_E), .Jump_E(Jump_E),
        .ResultSrc_E(ResultSrc_E), .ALUControl_E(ALUControl_E), .funct3_E(funct3_E),
        .RD1_E(RD1_E), .RD2_E(RD2_E), .Imm_Ext_E(Imm_Ext_E), .RD_E(RD_E), .PC_E(PC_E), .PCPlus4_E(PCPlus4_E),
        .ResultW(Result_W), .ALU_Result_M(ALU_Result_M), .ForwardA_E(ForwardA_E), .ForwardB_E(ForwardB_E),
        .PCSrc_E(PCSrc_E), .PC_Target_E(PC_Target_E), .RegWrite_M(RegWrite_M), .MemWrite_M(MemWrite_M),
        .ResultSrc_M(ResultSrc_M), .RD_M(RD_M), .PCPlus4_M(PCPlus4_M), .WriteData_M(WriteData_M), .ALU_Result_M(ALU_Result_M)
    );

    memory_cycle memory (
        .clk(clk), .rst(rst), .RegWrite_M(RegWrite_M), .MemWrite_M(MemWrite_M), .ResultSrc_M(ResultSrc_M), .RD_M(RD_M),
        .PCPlus4_M(PCPlus4_M), .WriteData_M(WriteData_M), .ALU_Result_M(ALU_Result_M),
        .RegWrite_W(RegWrite_W), .ResultSrc_W(ResultSrc_W), .RD_W(RD_W),
        .PCPlus4_W(PCPlus4_W), .ALU_Result_W(ALU_Result_W), .ReadData_W(ReadData_W)
    );

    writeback_cycle writeback (
        .ResultSrc_W(ResultSrc_W), .PCPlus4_W(PCPlus4_W), .ALU_Result_W(ALU_Result_W), .ReadData_W(ReadData_W),
        .Result_W(Result_W)
    );

    hazard_unit hazard (
        .RS1_D(RS1_D), .RS2_D(RS2_D), .RS1_E(RS1_E), .RS2_E(RS2_E), .Rd_E(RD_E), .Rd_M(RD_M), .Rd_W(RD_W),
        .RegWrite_M(RegWrite_M), .RegWrite_W(RegWrite_W), .ResultSrc_E(ResultSrc_E), .PCSrc_E(PCSrc_E),
        .ForwardA_E(ForwardA_E), .ForwardB_E(ForwardB_E), .Stall_F(Stall_F), .Stall_D(Stall_D), .Flush_D(Flush_D), .Flush_E(Flush_E)
    );

endmodule